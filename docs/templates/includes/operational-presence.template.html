{#
Template for an operational-presence infobox

Sum up the total organisations at or below the current admin level, filtered by sector if provided,
then provide a breakdown by org type in the supplemental figures.
#}

{% if operational_presence.has_data %}
{% if sector %}
{% set op_filtered = operational_presence.data.withRows('sector_code', sector.code).withRows(operational_presence.latest_date).aggregate(["org_name", "org_acronym", "org_type_description"]).cache() %}
{% else %}
{% set op_filtered = operational_presence.data.withRows(operational_presence.latest_date).aggregate(["org_name", "org_acronym", "org_type_description"]).cache() %}
{% endif %}
{% if op_filtered.length() > 0 %}
<div class="infobox">
  <div class="key-figure">
    <span class="label">
      <span class="inner">Organisations responding</span>
    </span>
    {% set n=op_filtered.length() %}
    {% include "templates/includes/key-figure.template.html" %}
  </div>
  <table class="supplemental-figures">
    {% for type in op_filtered.values("org_type_description") | sort %}
    <tr>
      <td>{{ type | default("<unspecified>", true) }}</td>
      <td>{{ op_filtered.withRows("org_type_description", type).length() | nfmt }}</td>
    </tr>
    {% endfor %}
  </table>
  <div class="metadata">

    {% if op_use_provider_name %}
    <a class="data-link" href="table.html?category=coordination-context&amp;subcategory=operational-presence&amp;sector-code={{ sector.code }}&amp;{{ geo_type }}-code={{geo.code}}&amp;provider-{{ geo_type }}-name={{ geo.name }}">data</a>
    {% else %}
    <a class="data-link" href="table.html?category=coordination-context&amp;subcategory=operational-presence&amp;sector-code={{ sector.code }}&amp;{{ geo_type }}-code={{geo.code}}">data</a>
    {% endif %}
    
    |

    <span class="date">{{ operational_presence.latest_date | truncate(7, true, "") }}</span>

    <br />
    
    <span class="sources">{{ operational_presence.sources | join(", ") }}</span>
  </div>
  
</div>
{% endif %}
{% endif %}
